# ì•ˆì „í•œ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: Deploy Soobo MBTI (Safe)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Frontend & Backend
    runs-on: [self-hosted]

    steps:
      # 1. ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (ê¸°ì¡´ ìœ ì§€)
      - name: Deploy Frontend Files
        run: |
          # í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ë“¤ì„ Nginx ì›¹ ë£¨íŠ¸ë¡œ ë™ê¸°í™”
          sudo rsync -av --delete ./soobo-mbti/ /home/runner/apps/soobo-mbti-frontend/

      # 3. ë°±ì—”ë“œ ë°°í¬ ì¤€ë¹„ (ê¶Œí•œ í™•ì¸ í›„ ì‹¤í–‰)
      - name: Prepare Backend Deployment
        run: |
            # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ ìƒì„± (ê¶Œí•œ í™•ì¸)
            if [ ! -d "/home/runner/apps/soobo-mbti-backend" ]; then
              mkdir -p /home/runner/apps/soobo-mbti-backend || sudo mkdir -p /home/runner/apps/soobo-mbti-backend
            fi
            
            # ê¸°ì¡´ íŒŒì¼ë“¤ ì •ë¦¬
            rm -rf /home/runner/apps/soobo-mbti-backend/* 2>/dev/null || \
            sudo rm -rf /home/runner/apps/soobo-mbti-backend/* 2>/dev/null || true
            
            # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ ìì²´ë¥¼ ë³µì‚¬ (Docker ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€)
            cp -r ./backend /home/runner/apps/soobo-mbti-backend/ 2>/dev/null || \
            sudo cp -r ./backend /home/runner/apps/soobo-mbti-backend/
            
            # Docker Composeì™€ MongoDB ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
            cp ./docker-compose.yml /home/runner/apps/soobo-mbti-backend/ 2>/dev/null || \
            sudo cp ./docker-compose.yml /home/runner/apps/soobo-mbti-backend/
            
            cp -r ./mongo-init /home/runner/apps/soobo-mbti-backend/ 2>/dev/null || \
            sudo cp -r ./mongo-init /home/runner/apps/soobo-mbti-backend/

      # 4. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - name: Setup Environment Variables
        run: |
          cd /home/runner/apps/soobo-mbti-backend
          
          # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ ë‚´ì— .env íŒŒì¼ ìƒì„±
          cat > backend/.env <<EOF
          MONGODB_URI=mongodb://localhost:27017/soobo-mbti
          MONGODB_USER=soobo_user
          MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }}
          PORT=4000
          NODE_ENV=production
          ALLOWED_ORIGINS=https://soobo.sijun.dev
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=100
          EOF
          
          echo "ğŸ”§ ìƒì„±ëœ í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "MongoDB URI: mongodb://localhost:27017/soobo-mbti"
          echo "Port: 4000"
          
          # docker-composeìš© í™˜ê²½ ë³€ìˆ˜ (ë£¨íŠ¸ì— ìƒì„±)
          cat > .env.docker <<EOF
          MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }}
          MONGO_ROOT_PASSWORD=${{ secrets.MONGO_ROOT_PASSWORD }}
          EOF

      # 5. Docker ì‚¬ìš©ì ê·¸ë£¹ í™•ì¸ ë° ë°°í¬
      - name: Deploy Backend with Docker
        run: |
          cd /home/runner/apps/soobo-mbti-backend
          
          # Docker ê·¸ë£¹ í™•ì¸
          if groups $USER | grep -q '\bdocker\b'; then
            echo "âœ… User is in docker group"
            DOCKER_CMD="docker"
          else
            echo "âš ï¸ User not in docker group, using sudo"
            DOCKER_CMD="sudo docker"
          fi
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (orphan ì»¨í…Œì´ë„ˆë„ ì œê±°)
          $DOCKER_CMD compose --env-file .env.docker down --remove-orphans || true
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          $DOCKER_CMD image prune -f || true
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
          $DOCKER_CMD compose --env-file .env.docker up -d --build
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ë° ìƒíƒœ í™•ì¸
          echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 20
          
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          $DOCKER_CMD compose --env-file .env.docker ps
          
          echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 50ì¤„):"
          $DOCKER_CMD compose --env-file .env.docker logs soobo-mbti-backend --tail=50 || true
          
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ì„¸ë¶€ ì •ë³´:"
          $DOCKER_CMD inspect soobo-mbti --format='{{.State.Status}} - {{.State.Error}}' || true

      # 6. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: Health Check
        run: |
          echo "ğŸ” ì„œë²„ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
          
          # ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          for i in {1..60}; do
            if curl -f http://localhost:4000/health > /dev/null 2>&1; then
              echo "âœ… Backend server is healthy!"
              break
            fi
            echo "â³ Waiting for server... ($i/60)"
            sleep 3
          done
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ìµœì¢… í—¬ìŠ¤ ì²´í¬ ê²°ê³¼:"
          curl -s http://localhost:4000/health || echo "âŒ Health check failed"
          
          # API ê¸°ë³¸ ì •ë³´ í™•ì¸
          echo "ğŸ“‹ API ì •ë³´:"
          curl -s http://localhost:4000/ || echo "âŒ API info failed"

      # 7. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: Deployment Complete
        run: |
          echo "ğŸ‰ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸŒ Frontend: https://soobo.sijun.dev"
          echo "ğŸ”— API: https://soobo.sijun.dev/api"
          echo "â¤ï¸ Health: https://soobo.sijun.dev/api/health"

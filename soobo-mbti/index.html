<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수면 MBTI</title>
    <link rel="stylesheet" href="style.css">
</head>
<body data-kakao-app-key="93298b5c87e46c48f2ba181afb1d27fd">
    <div class="mobile-container">
        <h1>수면 MBTI</h1>
        <p>설명</p>
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
            Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
        </p>

        <div>
            <button id="share-btn">공유하기</button>
            <button id="start-btn" onclick="startTest()">테스트하기</button>
        </div>
    </div>

    <div id="share-overlay" class="modal-overlay" hidden></div>
    <div id="share-sheet" class="bottom-sheet" aria-hidden="true">
        <div class="sheet-handle"></div>
        <div class="sheet-title">공유하기</div>
        <div class="share-grid">
            <button class="share-item" data-share="kakao">카카오톡</button>
            <button class="share-item" data-share="facebook">페이스북</button>
            <button class="share-item" data-share="twitter">트위터</button>
            <button class="share-item" data-share="copy">링크 복사</button>
            <button class="share-item" data-share="system">시스템 공유</button>
        </div>
        <button id="share-cancel" class="sheet-cancel">취소</button>
    </div>
</body>
</html>

<script>
    function startTest() {
        window.location.href = 'question.html';
    }
</script>

<script>
    (function() {
        const shareButton = document.getElementById('share-btn');
        const overlay = document.getElementById('share-overlay');
        const sheet = document.getElementById('share-sheet');
        const cancelButton = document.getElementById('share-cancel');

        function openSheet() {
            overlay.hidden = false;
            sheet.setAttribute('aria-hidden', 'false');
            sheet.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSheet() {
            sheet.classList.remove('active');
            sheet.setAttribute('aria-hidden', 'true');
            overlay.hidden = true;
            document.body.style.overflow = '';
        }

        function getShareData() {
            const url = window.location.href;
            const title = document.title || '수면 MBTI 테스트';
            const text = '수면 MBTI 테스트를 해보세요!';
            return { title, text, url };
        }

        function openPopup(url) {
            const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
            const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;
            const width = 520;
            const height = 600;
            const left = (window.innerWidth / 2) - (width / 2) + dualScreenLeft;
            const top = (window.innerHeight / 2) - (height / 2) + dualScreenTop;
            window.open(url, '_blank', `scrollbars=yes, width=${width}, height=${height}, top=${top}, left=${left}`);
        }

        async function shareToSystem() {
            const { title, text, url } = getShareData();
            if (navigator.share) {
                try {
                    await navigator.share({ title, text, url });
                    closeSheet();
                    return;
                } catch (e) {}
            }
            copyToClipboard();
            alert('시스템 공유를 사용할 수 없어 링크를 복사했어요.');
        }

        function shareToFacebook() {
            const { url } = getShareData();
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            openPopup(shareUrl);
            closeSheet();
        }

        function shareToTwitter() {
            const { url, text } = getShareData();
            const shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
            openPopup(shareUrl);
            closeSheet();
        }

        function copyToClipboard() {
            const { url } = getShareData();
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {}).catch(() => {});
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = url;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try { document.execCommand('copy'); } catch (e) {}
                document.body.removeChild(textarea);
            }
        }

        function loadKakaoSDK(appKey) {
            return new Promise((resolve, reject) => {
                if (window.Kakao && window.Kakao.isInitialized && window.Kakao.isInitialized()) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js';
                script.crossOrigin = 'anonymous';
                script.onload = () => {
                    try {
                        if (!window.Kakao.isInitialized()) {
                            window.Kakao.init(appKey);
                        }
                        resolve();
                    } catch (e) { reject(e); }
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function shareToKakao() {
            const appKey = document.body.getAttribute('data-kakao-app-key') || '';
            const { title, text, url } = getShareData();

            if (appKey) {
                try {
                    await loadKakaoSDK(appKey);
                    if (window.Kakao && window.Kakao.Share) {
                        window.Kakao.Share.sendDefault({
                            objectType: 'feed',
                            content: {
                                title: title,
                                description: text,
                                imageUrl: 'https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_medium.png',
                                link: { mobileWebUrl: url, webUrl: url }
                            },
                            buttons: [
                                {
                                    title: '자세히 보기',
                                    link: { mobileWebUrl: url, webUrl: url }
                                }
                            ]
                        });
                        closeSheet();
                        return;
                    }
                } catch (e) {
                    // fall through to fallback
                }
            }

            if (navigator.share) {
                try {
                    await navigator.share({ title, text, url });
                    closeSheet();
                    return;
                } catch (e) {}
            }
            copyToClipboard();
            alert('카카오톡 공유 설정이 필요합니다. 링크를 복사했어요.');
        }

        function onShareItemClick(e) {
            const target = e.target.closest('.share-item');
            if (!target) return;
            const type = target.getAttribute('data-share');
            switch (type) {
                case 'kakao':
                    shareToKakao();
                    break;
                case 'facebook':
                    shareToFacebook();
                    break;
                case 'twitter':
                    shareToTwitter();
                    break;
                case 'copy':
                    copyToClipboard();
                    alert('링크를 복사했어요. 친구에게 공유해보세요!');
                    closeSheet();
                    break;
                case 'system':
                    shareToSystem();
                    break;
                default:
                    break;
            }
        }

        shareButton.addEventListener('click', openSheet);
        cancelButton.addEventListener('click', closeSheet);
        overlay.addEventListener('click', closeSheet);
        sheet.addEventListener('click', onShareItemClick);

        // 키보드 접근성: ESC로 닫기
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sheet.classList.contains('active')) {
                closeSheet();
            }
        });
    })();
 </script>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수면 MBTI 테스트</title>
    <link rel="stylesheet" href="style.css">
</head>
<body data-api-base="/api">
    <div id="main">
        <div id="progress">
            <div id="progressBar"></div>
        </div>

        <div id="qna">
            <div id="progress-info">1/15</div>
            <img id="question-img" src="" alt="질문 이미지">
            <h2 id="question">질문이 여기에 표시됩니다.</h2>
            <div id="answer-box">
                </div>
        </div>
    </div>
</body>
</html>


    <script src="api.js"></script>
    <script src="sleep-mbti-calculator.js"></script>
    <script>
    // --- 기능 구현 부분 ---
    const main = document.getElementById('main');
    const qna = document.getElementById('qna');
    const progressBar = document.getElementById('progressBar');
    const progressInfo = document.getElementById('progress-info');
    const qImg = document.getElementById('question-img');
    const question = document.getElementById('question');
    const answerBox = document.getElementById('answer-box');
    
    let currentQ = 0; // 현재 질문 번호
    const calculator = new SleepMBTICalculator(); // 새로운 계산기 인스턴스
    let qnaList = []; // JSON 데이터를 저장할 빈 배열
    let sessionId = null; // 백엔드 세션 ID

    // URL에서 세션 ID 추출
    const urlParams = new URLSearchParams(window.location.search);
    sessionId = urlParams.get('sessionId');

    // fetch를 사용해 JSON 파일 불러오기
    function loadQnA() {
        return fetch('./qna.json') // 1. JSON 파일 요청
            .then(response => response.json()) // 2. 응답을 JSON으로 파싱
            .then(data => {
                qnaList = data; // 3. 파싱된 데이터를 qnaList에 저장
            })
            .catch(error => console.error('Error loading Q&A data:', error));
    }

    // 페이지 로드 시 애니메이션 효과
    window.onload = () => {
        main.style.opacity = 1;
        main.style.transform = 'translateY(0)';
        qna.style.display = 'block';
        
        if (!sessionId) {
            alert('세션 정보가 없어 처음 화면으로 돌아갑니다.');
            window.location.href = 'index.html';
            return;
        }

        loadQnA().then(() => { // JSON 로딩이 완료된 후 검사 시작
            qna.style.display = 'block';
            goNext(currentQ);
        });
    };

    // 답변 버튼 클릭 시 호출될 함수
    const debouncedSave = ApiClient.debounce(async () => {
        try {
            const answers = Object.entries(calculator.answers).map(([qIndex, aIndex]) => ({
                questionId: `q${Number(qIndex) + 1}`,
                choiceId: String(aIndex),
                value: aIndex,
                answeredAt: new Date().toISOString()
            }));
            await ApiClient.saveAnswers(sessionId, answers);
        } catch (e) {
            // 저장 실패는 사용자 플로우를 막지 않음
        }
    }, 400);

    function selectAnswer(answerIndex) {
        // 선택한 답변을 계산기에 저장
        calculator.setAnswer(currentQ, answerIndex);
        debouncedSave();

        currentQ++; // 다음 질문으로
        
        if (currentQ === qnaList.length) {
            // 모든 질문에 답했으면 결과 페이지로 이동
            showResult();
        } else {
            goNext(currentQ);
        }
    }
    
    // 최종 결과 계산 및 페이지 이동
    async function showResult() {
        const result = calculator.calculateFinalResult();
        try {
            await ApiClient.completeSession(sessionId, {
                resultType: result.type,
                resultScores: {
                    morning: result.morning,
                    control: result.control,
                    rhythm: result.rhythm,
                    recovery: result.recovery
                },
                answers: Object.entries(calculator.answers).map(([qIndex, aIndex]) => ({
                    questionId: `q${Number(qIndex) + 1}`,
                    choiceId: String(aIndex),
                    value: aIndex,
                    answeredAt: new Date().toISOString()
                }))
            });
        } catch (e) {
            // 실패해도 결과 페이지 이동은 진행
        }

        const params = new URLSearchParams({
            type: result.type,
            morning: result.morning,
            control: result.control,
            rhythm: result.rhythm,
            recovery: result.recovery,
            sessionId
        });
        window.location.href = `result.html?${params.toString()}`;
    }

    // 다음 질문을 화면에 표시하는 함수
    function goNext(qIdx) {
        // 프로그레스 바 업데이트
        const progress = ((qIdx + 1) / qnaList.length) * 100;
        progressBar.style.width = progress + '%';

        // 진행 정보 업데이트
        progressInfo.textContent = `${qIdx + 1}/${qnaList.length}`;

        // 질문 내용 업데이트
        qImg.src = qnaList[qIdx].img;
        question.textContent = qnaList[qIdx].q;
        
        // 기존 답변 버튼 제거
        answerBox.innerHTML = ''; 

        // 새로운 답변 버튼 생성
        qnaList[qIdx].a.forEach((answerInfo, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = answerInfo.answer;
            btn.onclick = () => selectAnswer(index); // 클릭 이벤트 연결
            answerBox.appendChild(btn);
        });
    }
</script>
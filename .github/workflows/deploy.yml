name: Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up workspace paths
        id: paths
        run: |
          echo "APPS_DIR=$HOME/apps" >> $GITHUB_ENV
          echo "BACKEND_DIR=$HOME/apps/soobo-mbti-backend" >> $GITHUB_ENV
          echo "FRONTEND_DIR=$HOME/apps/soobo-mbti-frontend" >> $GITHUB_ENV

      - name: Prepare directories
        run: |
          mkdir -p "$APPS_DIR" "$BACKEND_DIR" "$FRONTEND_DIR"

      - name: Install backend deps
        working-directory: backend
        run: |
          npm ci

      - name: Build backend (if any)
        working-directory: backend
        run: |
          if [ -f package.json ] && node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)" ; then
            npm run build
          else
            echo "No backend build script. Skipping."
          fi

      - name: Deploy backend to $BACKEND_DIR
        run: |
          rsync -a --delete backend/ "$BACKEND_DIR/"

      - name: Install production deps in backend
        run: |
          cd "$BACKEND_DIR"
          npm ci --omit=dev

      - name: Restart backend app with PM2 (user-level)
        env:
          APP_NAME: soobo-backend
        run: |
          if ! command -v pm2 >/dev/null 2>&1; then
            npm i -g pm2
          fi
          # Start or reload without sudo
          if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
            pm2 reload "$APP_NAME" --update-env || pm2 restart "$APP_NAME"
          else
            pm2 start src/server.js --name "$APP_NAME" --cwd "$BACKEND_DIR"
          fi
          pm2 save

      - name: Build frontend assets
        working-directory: soobo-mbti
        run: |
          # 정적 파일 프로젝트면 빌드 없이 복사만 수행
          if [ -f package.json ]; then
            npm ci
            if node -e "p=require('./package.json');process.exit(p.scripts&&p.scripts.build?0:1)" ; then
              npm run build
              echo "FRONT_BUILD_DIST=dist" >> $GITHUB_ENV
            else
              echo "FRONT_BUILD_DIST=." >> $GITHUB_ENV
            fi
          else
            echo "FRONT_BUILD_DIST=." >> $GITHUB_ENV
          fi

      - name: Deploy frontend to $FRONTEND_DIR
        run: |
          SRC_DIR="soobo-mbti/${FRONT_BUILD_DIST:-.}"
          rsync -a --delete "$SRC_DIR/" "$FRONTEND_DIR/"

      - name: Serve frontend with PM2 (user-level)
        env:
          FRONT_APP: soobo-frontend
        run: |
          if ! command -v pm2 >/dev/null 2>&1; then
            npm i -g pm2
          fi
          # pm2 serve keeps process alive beyond workflow lifetime
          if pm2 describe "$FRONT_APP" >/dev/null 2>&1; then
            pm2 delete "$FRONT_APP" || true
          fi
          pm2 serve "$FRONTEND_DIR" 8080 --name "$FRONT_APP"
          pm2 save

